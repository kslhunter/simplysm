# orm-node 패키지 코드 리뷰

## 개요

- **리뷰 대상**: `packages/orm-node` 패키지
- **리뷰 범위**:
  - 소스 코드: `src/` 디렉토리 전체 (8개 파일)
  - 테스트 코드: `tests/orm/src/db-conn/` 및 `tests/orm/src/db-context/`
  - 문서: `README.md`
- **리뷰 일자**: 2026-02-03
- **제외 사항**: `dist/` 빌드 결과물

## 발견 사항

### 코딩 지침 위반

| 심각도 | 파일 | 내용 | 결정 |
|--------|------|------|------|
| **Minor** | `README.md` | 메서드명에 `Async` 접미사 사용 + 실제 API와 불일치 | 전체 검토/수정 |
| **Minor** | `node-db-context-executor.ts:166` | `Error` 대신 `SdError` 사용해야 함 (일관성) | 수정 |
| **Minor** | `mssql-db-conn.ts:302,325` | `_assertConnected()` 후 불필요한 optional chaining | 수정 |

### 안정성

| 심각도 | 파일 | 내용 | 결정 |
|--------|------|------|------|
| **Major** | `mssql-db-conn.ts:108,113` | `waitUntil` 호출 시 타임아웃 없음 (무한 대기 가능) | 30초 타임아웃 추가 |
| **Major** | `pooled-db-conn.ts:59-71` | 풀 반환 시 트랜잭션 롤백 누락 | 롤백 추가 |

### 성능

| 심각도 | 파일 | 내용 | 결정 |
|--------|------|------|------|
| **Minor** | `db-conn-factory.ts:38` | 풀 캐시 키 생성 시 중첩 객체 정렬 안됨 (풀 중복 가능) | 재귀적 정렬 추가 |

### 유지보수성

| 심각도 | 파일 | 내용 | 결정 |
|--------|------|------|------|
| **Minor** | `mysql-db-conn.ts:49` | root 사용자 특수 처리 로직의 의도가 불명확 | 주석 추가 |
| **Minor** | `postgresql-db-conn.ts:82-106` | 트랜잭션 메서드에서 `_startTimeout()` 누락 | 추가 |
| **Minor** | `mysql-db-conn.ts:180` | 임시 파일명이 타임스탬프 기반으로 예측 가능 | randomUUID 사용 |

### 테스트 커버리지

| 심각도 | 파일 | 내용 | 결정 |
|--------|------|------|------|
| **Minor** | `tests/orm/src/db-conn/*.spec.ts` | bulkInsert NULL 값 테스트 누락 | 테스트 추가 |
| **Minor** | `tests/orm/src/db-conn/*.spec.ts` | bulkInsert UUID, binary 타입 테스트 누락 | 테스트 추가 |
| **Minor** | `tests/orm/src/db-conn/*.spec.ts` | 트랜잭션 격리 수준 테스트 누락 | 테스트 추가 |

### 검토 후 유지

| 심각도 | 파일 | 내용 | 결정 |
|--------|------|------|------|
| **Suggestion** | `db-conn-factory.ts:17` | 정적 풀 캐시의 명시적 해제 메서드 부재 | 현재 설계 유지 |

## 수정 계획

### 1. README.md 문서 전체 검토/수정

**위치**: `packages/orm-node/README.md`

**변경 내용**:
- `Async` 접미사 제거: `connectAsync` → `connect`, `resultAsync` → `result` 등
- 예제 코드가 실제 API와 일치하는지 전체 검토

### 2. NodeDbContextExecutor 에러 타입 통일

**위치**: `packages/orm-node/src/node-db-context-executor.ts:165-170`

**수정 코드**:
```typescript
import { SdError } from "@simplysm/core-common";
import { DB_CONN_ERRORS } from "./types/db-conn";

private _requireConn(): DbConn {
  if (this._conn == null) {
    throw new SdError(DB_CONN_ERRORS.NOT_CONNECTED);
  }
  return this._conn;
}
```

### 3. MssqlDbConn waitUntil 타임아웃 추가

**위치**: `packages/orm-node/src/connections/mssql-db-conn.ts:108,113`

**수정 코드**:
```typescript
await waitUntil(() => this._requests.length < 1, 30000, 100);
// ...
waitUntil(() => this._conn == null, 30000, 100)
```

### 4. MysqlDbConn root 사용자 로직 주석 추가

**위치**: `packages/orm-node/src/connections/mysql-db-conn.ts:49`

**수정 코드**:
```typescript
// root 사용자는 특정 database에 바인딩되지 않고 연결하여
// 모든 데이터베이스에 접근할 수 있도록 함 (관리 작업용)
database: this.config.username === MysqlDbConn._ROOT_USER ? undefined : this.config.database,
```

### 5. MssqlDbConn bulkInsert optional chaining 수정

**위치**: `packages/orm-node/src/connections/mssql-db-conn.ts:302,325`

**수정 코드**:
```typescript
const bulkLoad = this._conn!.newBulkLoad(tableName, (err) => {
// ...
this._conn!.execBulkLoad(bulkLoad, rows);
```

### 6. PooledDbConn 트랜잭션 롤백 추가

**위치**: `packages/orm-node/src/pooled-db-conn.ts:59-71`

**수정 코드**:
```typescript
async close(): Promise<void> {
  if (this._rawConn != null) {
    // 트랜잭션 진행 중이면 롤백하여 깨끗한 상태로 풀에 반환
    if (this._rawConn.isOnTransaction) {
      await this._rawConn.rollbackTransaction();
    }

    this._rawConn.off("close", this._onRawConnClose);
    await this._pool.release(this._rawConn);
    this._rawConn = undefined;
    this.emit("close");
  }
}
```

### 7. PostgresqlDbConn 타임아웃 갱신 추가

**위치**: `packages/orm-node/src/connections/postgresql-db-conn.ts:82-106`

**수정 내용**: `beginTransaction`, `commitTransaction`, `rollbackTransaction` 메서드 끝에 `this._startTimeout()` 호출 추가

### 8. DbConnFactory 풀 캐시 키 재귀적 정렬

**위치**: `packages/orm-node/src/db-conn-factory.ts:38`

**현재 코드**:
```typescript
const configKey = JSON.stringify(config, Object.keys(config).sort());
```

**수정 코드**:
```typescript
const configKey = JSON.stringify(config, (_, value) =>
  value && typeof value === "object" && !Array.isArray(value)
    ? Object.fromEntries(Object.entries(value).sort(([a], [b]) => a.localeCompare(b)))
    : value
);
```

### 9. MysqlDbConn 임시 파일명 randomUUID 사용

**위치**: `packages/orm-node/src/connections/mysql-db-conn.ts:179-180`

**현재 코드**:
```typescript
const tmpDir = os.tmpdir();
const tmpFile = path.join(tmpDir, `mysql_bulk_${Date.now()}_${Math.random().toString(36).slice(2)}.csv`);
```

**수정 코드**:
```typescript
import { randomUUID } from "crypto";

const tmpDir = os.tmpdir();
const tmpFile = path.join(tmpDir, `mysql_bulk_${randomUUID()}.csv`);
```

### 10. 테스트 추가 (별도 작업)

- bulkInsert NULL 값 테스트
- bulkInsert UUID, binary 타입 테스트
- 트랜잭션 격리 수준 테스트

## 긍정적인 측면

1. **일관된 구조**: 모든 DB 커넥션 클래스가 동일한 인터페이스 (`DbConn`)를 구현
2. **충분한 테스트 커버리지**: 연결, 쿼리 실행, 트랜잭션, bulkInsert 등 주요 기능 테스트 완비
3. **커넥션 풀 지원**: `generic-pool` 라이브러리를 활용한 효율적인 풀 관리
4. **타임아웃 관리**: 연결 유휴 타임아웃 처리로 리소스 관리 양호
5. **지연 로딩**: DB 드라이버 모듈의 지연 로딩으로 불필요한 드라이버 로드 방지

## 요약

| 심각도 | 개수 | 비고 |
|--------|------|------|
| Major | 2 | 안정성 (waitUntil 타임아웃, 트랜잭션 롤백) |
| Minor | 10 | 코딩 지침, 유지보수성, 성능, 테스트 |
| Suggestion | 1 | 현재 설계 유지 |
